---
title: "State variable level"
author: "Renata Diaz"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(MATSS)
library(dplyr)
library(tidyr)
library(ggplot2)
library(drake)


source(here::here("analysis", "portal_pilot_work", "scripts", "trends.R"))
```

```{r portal rodents ts}

annualrats = read.csv(here::here("analysis", "portal_pilot_work", "data", "portal_rats_sv.csv"), stringsAsFactors = F)

ggplot(annualrats, aes(x = year, y = total_abund, group = treatment, color = treatment)) +
  geom_line() +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(vars(treatment), scales = "free_y") +
  theme_bw() +
  ggtitle("Total abundance")


ggplot(annualrats, aes(x = year, y = total_energy, group = treatment, color = treatment)) +
  geom_line() +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(vars(treatment), scales = "free_y") +
  theme_bw() +
  ggtitle("Total energy")


```


BioTIME analyses:

- Regulation vs. random walk
- Trends: significance and slope


## Trends: Significance and slope


```{r a single trend}

abund_ts <- lapply(unique(annualrats$treatment), FUN = pull_sv_ts, some_ts = annualrats, currency = "total_abund")

abund_trends <- lapply(abund_ts, FUN = bt_trend)

abund_trends <- bind_rows(abund_trends) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "abundance")



energy_ts <- lapply(unique(annualrats$treatment), FUN = pull_sv_ts, some_ts = annualrats, currency = "total_energy")

energy_trends <- lapply(energy_ts, FUN = bt_trend)

energy_trends <- bind_rows(energy_trends) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "energy")

all_trends <- bind_rows(abund_trends, energy_trends)



ggplot(all_trends, aes(x = slope, y = p, color = treatment, size = r2)) +
  geom_point(alpha = .5) + 
  geom_hline(yintercept = .05) +
  geom_vline(xintercept = 0) +
  facet_wrap(vars(currency)) + 
  theme_bw() +
  xlim(-.1, .1)


```


## Gleanings

- All slopes for abundance are significant to .05 and positive; only 2 are significant for energy. 
- For abundance, all communities have slopes that are positive (but not huge - around .05) and significant. 
- For energy, control has a near-0 slope and not significant, terrible r2. Spectabs has positive slope but not significant. Exclosure and removal have positive slopes, significant.
