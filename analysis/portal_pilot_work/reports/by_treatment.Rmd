---
title: "By treatment"
author: "Renata Diaz"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(MATSS)
library(dplyr)
library(tidyr)
library(ggplot2)
library(drake)


source(here::here("analysis", "portal_pilot_work", "scripts", "trends.R"))
source(here::here("analysis", "portal_pilot_work", "scripts", "regulation.R"))

```

# State variable 

```{r portal rodents ts}

annualrats = read.csv(here::here("analysis", "portal_pilot_work", "data", "portal_rats_sv.csv"), stringsAsFactors = F)

this_treatment <- unique(annualrats$treatment)[1]

annualrats <- filter(annualrats, treatment == this_treatment)

ggplot(annualrats, aes(x = year, y = total_abund, group = treatment, color = treatment)) +
  geom_line() +
  geom_smooth(method = "lm", se = F) +
  theme_bw() +
  ggtitle("Total abundance")


ggplot(annualrats, aes(x = year, y = total_energy, group = treatment, color = treatment)) +
  geom_line() +
  geom_smooth(method = "lm", se = F) +
  theme_bw() +
  ggtitle("Total energy")


```


BioTIME analyses:

- Regulation vs. random walk
- Trends: significance and slope


## Trends: Significance and slope


```{r a single trend}

abund_ts <- lapply(unique(annualrats$treatment), FUN = pull_sv_ts, some_ts = annualrats, currency = "total_abund")

abund_trends <- lapply(abund_ts, FUN = bt_trend)

abund_trends <- bind_rows(abund_trends) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "abundance")


energy_ts <- lapply(unique(annualrats$treatment), FUN = pull_sv_ts, some_ts = annualrats, currency = "total_energy")

energy_trends <- lapply(energy_ts, FUN = bt_trend)

energy_trends <- bind_rows(energy_trends) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "energy")

all_trends <- bind_rows(abund_trends, energy_trends)

print(all_trends)


```


## Gleanings

- All slopes for abundance are significant to .05 and positive; only 2 are significant for energy. 
- For abundance, all communities have slopes that are positive (but not huge - around .05) and significant. This contrasts to findings from population-level (see pop.Rmd): there, slopes are concentrated around 0. But more variable and sometimes much larger? 

- For energy, control has a near-0 slope and not significant, terrible r2. Spectabs has positive slope but not significant. Exclosure and removal have positive slopes, significant.


# Regulation


```{r regulation}

abund_reg <- lapply(abund_ts, FUN = bt_adf)

abund_reg <- bind_rows(abund_reg) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "abundance")

energy_reg <- lapply(energy_ts, FUN = bt_adf)

energy_reg <- bind_rows(energy_reg) %>%
  mutate(treatment = unique(annualrats$treatment),
         currency = "energy")

all_reg <- bind_rows(abund_reg, energy_reg)

ggplot(all_reg, aes(x = stat, y = p, color = treatment)) +
  geom_point() +
  theme_bw() +
  facet_wrap(vars(currency)) +
  geom_hline(yintercept = .05)

```
